stages:
- stage: Release

  dependsOn: Test
  condition: succeeded('Test')

  jobs:
  - deployment: Deploy
    displayName: "Import solution artifact"

    pool:
      vmImage: 'vs2017-win2016'
    
    environment: test
    strategy:
      runOnce:
        deploy:

          steps:
          - task: DownloadBuildArtifacts@0
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'drop'
              downloadPath: '$(System.ArtifactsDirectory)'
          
          - powershell: Install-Module Microsoft.Xrm.Data.Powershell -Scope CurrentUser -Force
            displayName: 'Install Microsoft.Xrm.Data.PowerShell'

          - powershell: |
              Write-Host `
                ("AuthType = Office365;" + `
                  "Username = $env:ServiceAccountUpn;" + `
                  "Password = $env:ServiceAccountPassword;" + `
                  "Url = https://$env:ENVIRONMENT_NAME.crm.dynamics.com")
              
              $connection = Get-CrmConnection `
                -ConnectionString `
                  ("AuthType = Office365;" + `
                  "Username = $env:ServiceAccountUpn;" + `
                  "Password = $env:ServiceAccountPassword;" + `
                  "Url = https://$env:ENVIRONMENT_NAME.crm.dynamics.com")

              Import-CrmSolutionAsync `
                -BlockUntilImportComplete `
                -conn $connection `
                -SolutionFilePath $(System.ArtifactsDirectory)\drop\packedSolution\$($env:SolutionName)_managed.zip
            env:
              SolutionName: $(solution.name)
              ServiceAccountUpn: $(serviceAccount.upn)
              ServiceAccountPassword: $(serviceAccount.password)
            displayName: 'Import solution'
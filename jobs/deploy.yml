parameters:
  environment: ''
  jobProperties:
    dependsOn: 'Build'
    condition: 'succeeded(''Build'')'
  powerAppsEnvironment:
    connectionString: '$(environment.connectionString)'
    serviceConnection: '$(environment.serviceConnection)'
  solutionZipPath: '$(Pipeline.Workspace)\packed-solution\$(solution.name).zip'
  toolset: 'powershell'
  toolsDirectory: '$(Pipeline.Workspace)\tools'

jobs:
- deployment: ${{ coalesce(parameters.jobProperties.name, 'Deploy') }}

  ${{ if eq(parameters.jobProperties.pool, '') }}:
    pool:
      vmImage: 'windows-latest'
  
  ${{ if eq(parameters.jobProperties.environment, '') }}:
    environment: ${{ parameters.environment }}

  ${{ each pair in parameters.jobProperties }}:
    ${{ if not(in(pair.key, 'name', 'pool')) }}:
      ${{ pair.key }}: ${{ pair.value }}

  strategy:
    runOnce:
      deploy:
        steps:
        - template: ../steps/install-tools.yml
          parameters:
            toolset: ${{ parameters.toolset }}
            toolsDirectory: ${{ parameters.toolsDirectory }}

        - template: ../steps/import-solution.yml
          parameters:
            powerAppsEnvironment: ${{ parameters.environmentDetails }}
            solutionZipPath: ${{ parameters.solutionZipPath }}
            toolset: ${{ parameters.toolset }}
            toolsDirectory: ${{ parameters.toolsDirectory }}
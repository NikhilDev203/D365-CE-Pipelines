parameters:
  powerAppsEnvironment: ''
  solutionName: ''

steps:
  - task: PowerAppsImportSolution@0
    inputs:
      PowerAppsEnvironment: '${{ parameters.powerAppsEnvironment }}'
      SolutionInputFile: '$(Pipeline.Workspace)\${{ parameters.solutionName }}.zip'
      ConvertToManaged: false
      HoldingSolution: false
      OverwriteUnmanagedCustomizations: true
      PublishWorkflows: true
      SkipProductUpdateDependencies: true

  - task: PowerAppsExportSolution@0
    inputs:
      PowerAppsEnvironment: 'Meecrosoft-build'
      SolutionName: '${{ parameters.solutionName }}'
      SolutionOutputFile: '$(Pipeline.Workspace)\${{ parameters.solutionName }}_managed.zip'
      Managed: true
      ExportAutoNumberingSettings: false
      ExportCalendarSettings: false
      ExportCustomizationSettings: false
      ExportEmailTrackingSettings: false
      ExportGeneralSettings: false
      ExportIsvConfig: false
      ExportMarketingSettings: false
      ExportOutlookSynchronizationSettings: false
      ExportRelationshipRoles: false
      ExportSales: false
    displayName: 'PowerApps Export Solution - ${{ parameters.solutionName }}_managed.zip'
    
  - publish: $(Pipeline.Workspace)\${{ parameters.solutionName }}_managed.zip
    artifact: drop
    displayName: "Publish pipeline artifact - ${{ parameters.solutionName }}_managed.zip as drop"